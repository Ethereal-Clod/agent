# ğŸ¡ AI ç”¨ç”µåŠ©æ‰‹ (å®¶åº­ç‰ˆ)

ä¸€ä¸ªåŸºäº FastAPI + LangGraph çš„å®¶åº­ç”¨ç”µæ™ºèƒ½åŠ©æ‰‹åç«¯ç¤ºä¾‹ï¼Œæä¾›ç”¨æˆ·è®¤è¯ã€æ•°æ®åˆ†æã€æ™ºèƒ½æ§åˆ¶ä¸ AI èŠå¤©æ¥å£ã€‚å‰ç«¯ï¼ˆVue3ï¼‰é€šè¿‡ REST API ä¸è¯¥æœåŠ¡äº¤äº’ã€‚

---

## é¡¹ç›®ç»“æ„

- `backend/app`ï¼šFastAPI æºç 
  - `core`ï¼šé…ç½®ã€åŠ å¯†ç­‰é€šç”¨æ¨¡å—
  - `db`ï¼šSQLAlchemy å¼•æ“å’Œ Base
  - `models`ï¼šORM æ¨¡å‹ï¼ˆå½“å‰å·²å®ç° `User`ï¼‰
  - `schemas`ï¼šPydantic æ•°æ®æ¨¡å‹
  - `api/endpoints`ï¼šè·¯ç”±å®šä¹‰ï¼ˆé¦–æ‰¹å®Œæˆäº† Authï¼‰
- `doc/`ï¼šç³»ç»Ÿè®¾è®¡ä¸ API æ–‡æ¡£ï¼ˆV2.0ï¼‰
- `db/schema.sql`ï¼šMySQL æ•°æ®å»ºè¡¨è„šæœ¬

---

## å¿«é€Ÿå¼€å§‹

1. **å®‰è£…ä¾èµ–**
   ```bash
   cd backend
   python -m venv .venv
   source .venv/Scripts/activate  # Windows PowerShell
   pip install -r requirements.txt
   ```

2. **é…ç½®ç¯å¢ƒå˜é‡ï¼ˆå¯é€‰ï¼‰**  
   åœ¨ `backend` ç›®å½•åˆ›å»º `.env`ï¼š
   ```
   DATABASE_URL=mysql+pymysql://group-user:123456@localhost:3306/ai_power_db
   SECRET_KEY=è¯·æ›¿æ¢ä¸ºéšæœºå­—ç¬¦ä¸²
   ACCESS_TOKEN_EXPIRE_MINUTES=60
   ```
   è‹¥ä¸é…ç½®ï¼Œå°†é»˜è®¤è¿æ¥ `mysql+pymysql://group-user:123456@localhost:3306/ai_power_db`ã€‚

3. **åˆå§‹åŒ–æ•°æ®åº“**
   - é€‰æ‹© MySQLï¼šæ‰§è¡Œ `db/schema.sql`
   - æˆ– SQLiteï¼šé¦–æ¬¡è¿è¡ŒæœåŠ¡ä¼šè‡ªåŠ¨å»ºè¡¨

4. **å¯åŠ¨æœåŠ¡**
   ```bash
   uvicorn app.main:app --reload
   ```
   è®¿é—® `http://localhost:8000/docs` æŸ¥çœ‹è‡ªåŠ¨ç”Ÿæˆçš„æ¥å£æ–‡æ¡£ã€‚

---

## å·²å®ç°åŠŸèƒ½æ¨¡å—

### ğŸ” èº«ä»½è®¤è¯æ¨¡å— (Authentication)

| Method | URL                | æè¿°           |
|--------|--------------------|----------------|
| POST   | `/api/auth/register` | æ³¨å†Œæ–°ç”¨æˆ·      |
| POST   | `/api/auth/token`    | ç™»å½•å¹¶è·å– Token |  
| GET    | `/api/auth/me`       | è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ |
| POST   | `/api/auth/logout`   | é€€å‡ºç™»å½•ï¼ˆå‰ç«¯æ¸… Tokenï¼‰ |

> å¯†ç è§„åˆ™ï¼šé•¿åº¦éœ€åœ¨ 6~30 ä¸ªå­—ç¬¦ä¹‹é—´ï¼Œç³»ç»Ÿä¼šåœ¨å­˜å‚¨å‰è¿›è¡Œæˆªæ–­å“ˆå¸Œï¼Œæœ€ç»ˆåŠ å¯†ä¸²ä¹Ÿä¸è¶…è¿‡ 30 ä¸ªå­—ç¬¦ã€‚

### ğŸ’¡ æ™ºèƒ½è®¾å¤‡ç®¡ç†æ¨¡å— (Smart Control)

| Method | URL                              | æè¿°                     |
|--------|----------------------------------|--------------------------|
| POST   | `/api/appliances`                | æ·»åŠ æ–°ç”µå™¨                |
| GET    | `/api/appliances`                | è·å–å½“å‰ç”¨æˆ·çš„ç”µå™¨åˆ—è¡¨     |
| POST   | `/api/appliances/{id}/control`   | æ§åˆ¶ç”µå™¨å¼€å…³ï¼ˆAI ä»‹å…¥ï¼‰    |

**åŠŸèƒ½ç‰¹ç‚¹:**
- æ”¯æŒæ·»åŠ å¤šç§ç±»å‹çš„ç”µå™¨ï¼ˆç©ºè°ƒã€å†°ç®±ã€ç…§æ˜ã€ç”µè§†ã€çƒ­æ°´å™¨ç­‰ï¼‰
- ç”µå™¨çŠ¶æ€å®æ—¶ç®¡ç†ï¼ˆå¼€å…³çŠ¶æ€ï¼‰
- AI æ™ºèƒ½å»ºè®®ï¼šæ§åˆ¶ç”µå™¨æ—¶ä¼šè‡ªåŠ¨åˆ†æå¹¶ç»™å‡ºèŠ‚èƒ½å»ºè®®ï¼ˆå½“å‰ä¸ºæ¨¡æ‹Ÿ AI æœåŠ¡ï¼‰

> æ‰€æœ‰ `/api/appliances/*` æ¥å£éƒ½éœ€è¦å…ˆç™»å½•è·å– Tokenï¼Œå¹¶åœ¨è¯·æ±‚å¤´ä¸­æºå¸¦ `Authorization: Bearer <token>`

### è¯·æ±‚ç¤ºä¾‹
```http
POST /api/auth/register
{
  "username": "test001",
  "password": "securePass1",
  "address": "æ­å·å¸‚è¥¿æ¹–åŒº"
}
```

```http
POST /api/auth/token
{
  "username": "test001",
  "password": "securePass1"
}
```

---

## å¿«é€Ÿæµ‹è¯•æŒ‡å—

### 1. å¯åŠ¨æœåŠ¡
```bash
cd backend
uvicorn app.main:app --reload
```
è®¿é—® `http://localhost:8000/docs` æŸ¥çœ‹ Swagger UI è‡ªåŠ¨ç”Ÿæˆçš„æ¥å£æ–‡æ¡£ã€‚

### 2. æµ‹è¯•æµç¨‹

#### æ­¥éª¤ 1ï¼šæ³¨å†Œç”¨æˆ·
```bash
POST /api/auth/register
{
  "username": "test001",
  "password": "securePass1",
  "address": "æ­å·å¸‚è¥¿æ¹–åŒº"
}
```

#### æ­¥éª¤ 2ï¼šç™»å½•è·å– Token
```bash
POST /api/auth/token
{
  "username": "test001",
  "password": "securePass1"
}
```
å¤åˆ¶è¿”å›çš„ `access_token`ã€‚

#### æ­¥éª¤ 3ï¼šåœ¨ Swagger UI ä¸­æˆæƒ
ç‚¹å‡»å³ä¸Šè§’ "Authorize" æŒ‰é’®ï¼Œè¾“å…¥ï¼š`Bearer <access_token>`

#### æ­¥éª¤ 4ï¼šæ·»åŠ ç”µå™¨
```bash
POST /api/appliances
{
  "name": "å®¢å…ç©ºè°ƒ",
  "type": "ac",
  "power_rating": 2.5,
  "location": "Living Room"
}
```
è®°å½•è¿”å›çš„ `id`ï¼ˆä¾‹å¦‚ï¼š1ï¼‰ã€‚

#### æ­¥éª¤ 5ï¼šæŸ¥çœ‹ç”µå™¨åˆ—è¡¨
```bash
GET /api/appliances
```

#### æ­¥éª¤ 6ï¼šæ§åˆ¶ç”µå™¨ï¼ˆä½“éªŒ AI å»ºè®®ï¼‰
```bash
POST /api/appliances/1/control
{
  "action": "ON"
}
```
æŸ¥çœ‹è¿”å›çš„ `ai_message`ï¼Œä½“éªŒæ™ºèƒ½å»ºè®®åŠŸèƒ½ï¼

---

## å¼€å‘è¿›åº¦

### âœ… å·²å®ŒæˆåŠŸèƒ½
- [x] ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€è®¤è¯ï¼ˆJWT Tokenï¼‰
- [x] ç”µå™¨æ•°æ®æ¨¡å‹ï¼ˆORMï¼‰
- [x] ç”µå™¨ç®¡ç† APIï¼ˆæ·»åŠ ã€åˆ—è¡¨ã€æ§åˆ¶ï¼‰
- [x] æ¨¡æ‹Ÿ AI æœåŠ¡ï¼ˆæ™ºèƒ½å»ºè®®ï¼‰

### ğŸš§ è®¡åˆ’ä¸­åŠŸèƒ½
- [ ] ä»ªè¡¨ç›˜æ•°æ®æ¥å£ï¼ˆç”¨ç”µè¶‹åŠ¿ã€KPI æŒ‡æ ‡ï¼‰
- [ ] AI èŠå¤©é¡¾é—®æ¥å£
- [ ] çœŸå® AI Agent é›†æˆï¼ˆLangGraphï¼‰
- [ ] Alembic æ•°æ®åº“è¿ç§»ç®¡ç†
- [ ] ç”¨ç”µæ•°æ®æ¨¡æ‹Ÿå™¨
- [ ] è‡ªåŠ¨åŒ–æµ‹è¯•ä¸ CI/CD

---

## å˜æ›´è®°å½•ä¸åæ€

### 2025-01-XXï¼šç”µå™¨ç®¡ç†ä¸æ™ºèƒ½æ§åˆ¶æ¨¡å—
- **æ–°å¢åŠŸèƒ½**ï¼šå®Œæˆç”µå™¨æ¡£æ¡ˆç®¡ç†ã€ç”µå™¨åˆ—è¡¨æŸ¥è¯¢ã€æ™ºèƒ½æ§åˆ¶ï¼ˆAI ä»‹å…¥ï¼‰
- **æŠ€æœ¯å®ç°**ï¼š
  - åˆ›å»º `Appliance` ORM æ¨¡å‹ï¼Œä¸ `User` å»ºç«‹ä¸€å¯¹å¤šå…³ç³»
  - å®ç° Pydantic schemas ç”¨äºè¯·æ±‚/å“åº”éªŒè¯
  - å¼€å‘æ¨¡æ‹Ÿ AI æœåŠ¡ï¼Œåœ¨æ§åˆ¶ç”µå™¨æ—¶ç»™å‡ºæ™ºèƒ½å»ºè®®
  - å®Œæˆä¸‰ä¸ªæ ¸å¿ƒ API ç«¯ç‚¹ï¼šæ·»åŠ ç”µå™¨ã€æŸ¥è¯¢åˆ—è¡¨ã€æ§åˆ¶å¼€å…³
- **æ–‡ä»¶å˜æ›´**ï¼š
  - `backend/app/models/appliance.py` - ç”µå™¨ ORM æ¨¡å‹
  - `backend/app/models/user.py` - æ·»åŠ ä¸ç”µå™¨çš„å…³ç³»
  - `backend/app/schemas/appliance.py` - ç”µå™¨ç›¸å…³çš„ Pydantic æ¨¡å‹
  - `backend/app/services/mock_ai.py` - æ¨¡æ‹Ÿ AI æœåŠ¡
  - `backend/app/api/endpoints/appliances.py` - ç”µå™¨ç®¡ç† API
  - `backend/app/main.py` - æ³¨å†Œç”µå™¨è·¯ç”±
- **å¾…æ”¹è¿›**ï¼š
  - å½“å‰ AI æœåŠ¡ä¸ºæ¨¡æ‹Ÿå®ç°ï¼Œåç»­éœ€æ¥å…¥çœŸå®çš„ LangGraph Agent
  - æ•°æ®åº“è¿ç§»ï¼šå½“å‰ä½¿ç”¨ `Base.metadata.create_all()`ï¼Œå»ºè®®æ”¹ç”¨ Alembic ç®¡ç†ç‰ˆæœ¬

### 2025-11-19ï¼šç”¨æˆ·è®¤è¯æ¨¡å—
- **å®ŒæˆåŠŸèƒ½**ï¼šç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€`/me`ã€é€€å‡ºç™»å½•æ¥å£åŠæ•°æ®åº“è¿æ¥
- **é—®é¢˜**ï¼šå½“å‰ç¼ºå°‘ Token é»‘åå•æœºåˆ¶ï¼›åç»­éœ€è¦é…åˆ Redis æˆ–æŒä¹…åŒ–å­˜å‚¨å®ç°
- **æ”¹è¿›æ–¹å‘**ï¼šè¡¥å……é€Ÿç‡é™åˆ¶ä¸å®¡è®¡æ—¥å¿—ï¼Œç¡®ä¿å®‰å…¨åˆè§„

### 2025-12-01ï¼šæ•°æ®åº“æ¶æ„é‡æ„ä¸ç”¨ç”µè´¦æˆ·ç®¡ç†
- **æ–°å¢åŠŸèƒ½**ï¼šç”¨ç”µè´¦æˆ·è‡ªåŠ¨åˆ›å»ºã€å³°è°·ç”µä»·æ”¯æŒã€æ•°æ®åº“å…³ç³»ä¼˜åŒ–
- **æŠ€æœ¯å®ç°**ï¼š
  - é‡æ„æ•°æ®åº“æ¨¡å‹ï¼Œå¼•å…¥ `ElectricityAccount` ä¸­é—´è¡¨
  - ä¿®æ”¹æ³¨å†Œæ¥å£ï¼Œå®ç°ç”¨æˆ·æ³¨å†Œæ—¶è‡ªåŠ¨åˆ›å»ºç”¨ç”µè´¦æˆ·
  - ä¼˜åŒ–ç”µå™¨ä¸ç”¨æˆ·çš„å…³è”å…³ç³»ï¼š`User -> ElectricityAccount -> Appliance`
  - æ”¯æŒå³°è°·ç”µä»·é…ç½®ï¼Œä¸ºæœªæ¥ç”µè´¹è®¡ç®—åšå‡†å¤‡
- **æ–‡ä»¶å˜æ›´**ï¼š
  - `backend/app/models/electricity_account.py` - æ–°å¢ç”¨ç”µè´¦æˆ·ORMæ¨¡å‹
  - `backend/app/models/user.py` - æ·»åŠ ä¸ç”¨ç”µè´¦æˆ·çš„å…³ç³»
  - `backend/app/models/appliance.py` - ä¿®æ”¹å¤–é”®å…³è”åˆ°ç”¨ç”µè´¦æˆ·
  - `backend/app/api/endpoints/auth.py` - æ³¨å†Œæ—¶è‡ªåŠ¨åˆ›å»ºç”¨ç”µè´¦æˆ·
- **æ¶æ„ä¼˜åŠ¿**ï¼š
  - æ”¯æŒå¤æ‚çš„ç”µä»·ç­–ç•¥ï¼ˆå³°è°·ç”µä»·ï¼‰
  - ä¸ºç”¨ç”µè´¦å•å’Œæ•°æ®åˆ†æåŠŸèƒ½é¢„ç•™æ‰©å±•ç©ºé—´
  - æ›´å¥½çš„æ•°æ®éš”ç¦»å’Œå…³è”å®Œæ•´æ€§
- **æ•°æ®åº“å…¼å®¹æ€§**ï¼šç»Ÿä¸€ä½¿ç”¨BIGINTç±»å‹ï¼Œç¡®ä¿MySQLå…¼å®¹æ€§

